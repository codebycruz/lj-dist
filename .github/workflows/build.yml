name: Build LuaJIT

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        strategy:
            matrix:
                include:
                    # Linux builds
                    - os: ubuntu-latest
                      platform: linux
                      arch: x86-64
                      libc: gnu
                    - os: ubuntu-latest
                      platform: linux
                      arch: aarch64
                      libc: gnu
                    - os: ubuntu-latest
                      platform: linux
                      arch: aarch64
                      libc: musl
                    # Windows builds (cross-compiled from Linux)
                    - os: ubuntu-latest
                      platform: windows
                      arch: x86-64
                      libc: gnu

        runs-on: ${{ matrix.os }}

        steps:
            - name: Cache ARM64 toolchain
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'gnu'
              uses: actions/cache@v5
              with:
                  path: /var/cache/apt/archives
                  key: ${{ runner.os }}-apt-aarch64-toolchain

            - name: Cache ARM64 musl container
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'musl'
              uses: actions/cache@v5
              with:
                  path: /var/lib/docker
                  key: ${{ runner.os }}-docker-muslcc-aarch64

            - name: Cache MinGW toolchain
              if: matrix.platform == 'windows'
              uses: actions/cache@v5
              with:
                  path: /var/cache/apt/archives
                  key: ${{ runner.os }}-apt-mingw-toolchain

            - name: Install cross-compilation tools (Linux ARM64 GNU)
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

            - name: Pull musl toolchain container
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'musl'
              run: |
                  docker pull muslcc/x86_64:aarch64-linux-musl

            - name: Install cross-compilation tools (Windows)
              if: matrix.platform == 'windows'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

            - name: Checkout LuaJIT
              uses: actions/checkout@v6
              with:
                  repository: LuaJIT/LuaJIT
                  path: luajit

            - name: Build LuaJIT (Linux x86-64)
              if: matrix.platform == 'linux' && matrix.arch == 'x86-64'
              working-directory: luajit
              run: |
                  make STATIC_CC="gcc" BUILDMODE=static

            - name: Build LuaJIT (Linux ARM64 GNU)
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'gnu'
              working-directory: luajit
              run: |
                  make HOST_CC="gcc -m64" CROSS=aarch64-linux-gnu- STATIC_CC="aarch64-linux-gnu-gcc" BUILDMODE=static TARGET_SYS=Linux

            - name: Build LuaJIT (Linux ARM64 musl)
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64' && matrix.libc == 'musl'
              run: |
                  docker run --rm -v $PWD/luajit:/work -w /work muslcc/x86_64:aarch64-linux-musl \
                    sh -c 'apk add --no-cache make && make HOST_CC="gcc -m64" CROSS=aarch64-linux-musl- STATIC_CC="aarch64-linux-musl-gcc" BUILDMODE=static TARGET_SYS=Linux'

            - name: Build LuaJIT (Windows x86-64)
              if: matrix.platform == 'windows' && matrix.arch == 'x86-64'
              working-directory: luajit
              run: |
                  make HOST_CC="gcc -m64" CROSS=x86_64-w64-mingw32- STATIC_CC="x86_64-w64-mingw32-gcc" BUILDMODE=static TARGET_SYS=Windows

            # Package library (static lib + headers)
            - name: Package library (Linux)
              if: matrix.platform == 'linux'
              run: |
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/include
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/lib
                  cp -r luajit/src/*.h libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/include/
                  cp luajit/src/libluajit.a libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/lib/

            - name: Package library (Windows)
              if: matrix.platform == 'windows'
              run: |
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/include
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/lib
                  cp luajit/src/*.h libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/include/
                  cp luajit/src/libluajit.a libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/lib/

            # Package binary (executable only)
            - name: Package binary (Linux)
              if: matrix.platform == 'linux'
              run: |
                  mkdir -p luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}
                  cp luajit/src/luajit luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/

            - name: Package binary (Windows)
              if: matrix.platform == 'windows'
              run: |
                  mkdir -p luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}
                  cp luajit/src/luajit.exe luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/

            # Create tarballs
            - name: Create library tarball
              run: |
                  tar -czf libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}.tar.gz libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/

            - name: Create binary tarball
              run: |
                  tar -czf luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}.tar.gz luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}/

            # Upload to release
            - name: Upload to release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: latest
                  files: |
                      libluajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}.tar.gz
                      luajit-${{ matrix.platform }}-${{ matrix.arch }}-${{ matrix.libc }}.tar.gz
                  fail_on_unmatched_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
