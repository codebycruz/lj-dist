name: Build LuaJIT

on:
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        strategy:
            matrix:
                include:
                    # Linux builds
                    - os: ubuntu-latest
                      platform: linux
                      arch: x86-64
                      cc: gcc
                    - os: ubuntu-latest
                      platform: linux
                      arch: aarch64
                      cc: aarch64-linux-gnu-gcc
                    # Windows builds
                    - os: windows-latest
                      platform: windows
                      arch: x86-64
                      cc: gcc

        runs-on: ${{ matrix.os }}

        steps:
            - name: Cache ARM64 toolchain
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64'
              uses: actions/cache@v4
              with:
                  path: /var/cache/apt/archives
                  key: ${{ runner.os }}-apt-aarch64-toolchain

            - name: Install cross-compilation tools (Linux ARM64)
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

            - name: Checkout LuaJIT
              uses: actions/checkout@v4
              with:
                  repository: LuaJIT/LuaJIT
                  path: luajit

            - name: Build LuaJIT (Linux x86-64)
              if: matrix.platform == 'linux' && matrix.arch == 'x86-64'
              working-directory: luajit
              run: |
                  make STATIC_CC="gcc" BUILDMODE=static

            - name: Build LuaJIT (Linux ARM64)
              if: matrix.platform == 'linux' && matrix.arch == 'aarch64'
              working-directory: luajit
              run: |
                  make HOST_CC="gcc -m64" CROSS=aarch64-linux-gnu- STATIC_CC="aarch64-linux-gnu-gcc" BUILDMODE=static TARGET_SYS=Linux

            - name: Setup MSVC (Windows)
              if: matrix.platform == 'windows'
              uses: ilammy/msvc-dev-cmd@v1

            - name: Build LuaJIT (Windows x86-64)
              if: matrix.platform == 'windows' && matrix.arch == 'x86-64'
              working-directory: luajit/src
              shell: cmd
              run: msvcbuild.bat static

            # Package library (static lib + headers)
            - name: Package library (Linux)
              if: matrix.platform == 'linux'
              run: |
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}/include
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}/lib
                  cp -r luajit/src/*.h libluajit-${{ matrix.platform }}-${{ matrix.arch }}/include/
                  cp luajit/src/libluajit.a libluajit-${{ matrix.platform }}-${{ matrix.arch }}/lib/

            - name: Package library (Windows)
              if: matrix.platform == 'windows'
              shell: bash
              run: |
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}/include
                  mkdir -p libluajit-${{ matrix.platform }}-${{ matrix.arch }}/lib
                  cp luajit/src/*.h libluajit-${{ matrix.platform }}-${{ matrix.arch }}/include/
                  cp luajit/src/lua51.lib libluajit-${{ matrix.platform }}-${{ matrix.arch }}/lib/

            # Package binary (executable only)
            - name: Package binary (Linux)
              if: matrix.platform == 'linux'
              run: |
                  mkdir -p luajit-${{ matrix.platform }}-${{ matrix.arch }}
                  cp luajit/src/luajit luajit-${{ matrix.platform }}-${{ matrix.arch }}/

            - name: Package binary (Windows)
              if: matrix.platform == 'windows'
              shell: bash
              run: |
                  mkdir -p luajit-${{ matrix.platform }}-${{ matrix.arch }}
                  cp luajit/src/luajit.exe luajit-${{ matrix.platform }}-${{ matrix.arch }}/

            # Create tarballs
            - name: Create library tarball
              shell: bash
              run: |
                  tar -czf libluajit-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz libluajit-${{ matrix.platform }}-${{ matrix.arch }}/

            - name: Create binary tarball
              shell: bash
              run: |
                  tar -czf luajit-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz luajit-${{ matrix.platform }}-${{ matrix.arch }}/

            # Upload to release
            - name: Upload to release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: latest
                  files: |
                      libluajit-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz
                      luajit-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz
                  fail_on_unmatched_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
